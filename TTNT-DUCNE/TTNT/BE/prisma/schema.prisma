
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPING
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  FAILED
}

enum PaymentMethod {
  COD
  VNPAY
}

model User {
  userId    String @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  email String @unique
  phone String @unique
  passwordHash String
  address      String?
  role         UserRole  @default(CUSTOMER)
  isActive     Boolean   @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  orders     Order[]
  reviews    Review[]
  cart       Cart?
}

model Category {
  categoryId String @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  description String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  products   Product[]
}
model Product {
  productId   String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  categoryId  String @db.ObjectId
  thumbnail   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [categoryId])
  options     ProductOption[]
  orderItems  OrderItem[]
  cartItems   CartItem[]
  reviews     Review[]

  @@index([categoryId])
}

model ProductOption {
  optionId        String   @id @default(auto()) @map("_id") @db.ObjectId
  productId       String   @db.ObjectId
  color           String?
  version         String?
  price           Float
  salePrice       Float?
  discountPercent Float?
  stockQuantity   Int
  sku             String?  @unique
  image           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  product       Product  @relation(fields: [productId], references: [productId])
  orderItems    OrderItem[]
  cartItems     CartItem[]

  @@unique([productId, color, version])
}


model Cart {
  cartId    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [userId])
  items     CartItem[]

}

model CartItem {
  cartItemId  String  @id @default(auto()) @map("_id") @db.ObjectId
  cartId      String  @db.ObjectId
  productId   String  @db.ObjectId
  optionId    String? @db.ObjectId
  quantity    Int
  savedPrice  Float
  addedAt     DateTime @default(now())

  cart        Cart           @relation(fields: [cartId], references: [cartId])
  product     Product        @relation(fields: [productId], references: [productId])
  option      ProductOption? @relation(fields: [optionId], references: [optionId])

  @@index([cartId])
  @@index([productId])
  @@index([optionId])
}


model Order {
  orderId          String @id @default(auto()) @map("_id") @db.ObjectId
  userId           String @db.ObjectId
  totalPrice       Float
  status           OrderStatus @default(PENDING)
  shippingAddress  String
  paymentMethod    PaymentMethod
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User @relation(fields: [userId], references: [userId])
  items            OrderItem[]
  payments         Payment[]

  @@index([userId])
}

model OrderItem {
  orderItemId   String @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String @db.ObjectId
  productId     String @db.ObjectId
  optionId      String? @db.ObjectId
  quantity      Int
  unitPrice     Float
  optionPrice   Float?
  lineTotal     Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  order         Order @relation(fields: [orderId], references: [orderId])
  product       Product @relation(fields: [productId], references: [productId])
  option        ProductOption? @relation(fields: [optionId], references: [optionId])

  @@index([orderId])
  @@index([productId])
  @@index([optionId])
}


model Payment {
  paymentId        String @id @default(auto()) @map("_id") @db.ObjectId
  orderId          String @db.ObjectId
  paymentStatus    PaymentStatus @default(UNPAID)
  amount           Float
  transactionDate  DateTime @default(now())
  paymentMethod    PaymentMethod
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  order            Order @relation(fields: [orderId], references: [orderId])

  @@index([orderId])
}

model Review {
  reviewId  String   @id @default(auto()) @map("_id") @db.ObjectId
  productId String   @db.ObjectId
  userId    String   @db.ObjectId
  rating    Int
  comment   String?
  reply     String?
  repliedBy String?  @db.ObjectId
  repliedAt DateTime?
  createdAt DateTime @default(now())
  
  product   Product  @relation(fields: [productId], references: [productId])
  user      User     @relation(fields: [userId], references: [userId])
}